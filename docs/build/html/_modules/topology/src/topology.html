

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>topology.src.topology &mdash; TopologyPy 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TopologyPy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html#programmatic-usage">Programmatic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html#command-line-interface">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TopologyPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">topology.src.topology</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for topology.src.topology</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">topology.py</span>

<span class="sd">Base class for computing CMB covariance matrices for non-trivial topologies.</span>
<span class="sd">Implements preprocessing, CAMB integration, transfer function interpolation,</span>
<span class="sd">spherical harmonics computation, and covariance matrix calculations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">locale</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">import</span> <span class="nn">camb</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">getsizeof</span>

<div class="viewcode-block" id="Topology">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology">[docs]</a>
<span class="k">class</span> <span class="nc">Topology</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for CMB covariance matrix computation in non-trivial topologies.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        param (dict): Configuration parameters (e.g., topology, l_max, c_l_accuracy).</span>
<span class="sd">        topology (str): Topology type (e.g., &#39;E1&#39;).</span>
<span class="sd">        l_max (int): Maximum multipole.</span>
<span class="sd">        l_min (int): Minimum multipole.</span>
<span class="sd">        c_l_accuracy (float): Accuracy for wavevector cutoff (e.g., 0.99).</span>
<span class="sd">        C_l_type_array (np.ndarray): Array of correlation types [&#39;TT&#39;, &#39;EE&#39;, &#39;TE&#39;].</span>
<span class="sd">        do_polarization (bool): Whether to compute polarization (EE, TE).</span>
<span class="sd">        fig_name (str): Base name for output figures.</span>
<span class="sd">        debug (bool): Enable debug output.</span>
<span class="sd">        make_run_folder (bool): Create output directories.</span>
<span class="sd">        root (str): Output directory path.</span>
<span class="sd">        powers (np.ndarray): CMB power spectra from CAMB.</span>
<span class="sd">        k_list (np.ndarray): Wavevector magnitudes from CAMB.</span>
<span class="sd">        ell_list (np.ndarray): Multipoles from CAMB.</span>
<span class="sd">        transfer_T_interpolate_k_l_list (dict): Interpolated T transfer functions.</span>
<span class="sd">        transfer_E_interpolate_k_l_list (dict): Interpolated E transfer functions.</span>
<span class="sd">        k_max_list (np.ndarray): Wavevector cutoffs per multipole.</span>
<span class="sd">        k_amp (np.ndarray): Wavevector magnitudes.</span>
<span class="sd">        phi (np.ndarray): Wavevector azimuthal angles.</span>
<span class="sd">        theta (np.ndarray): Wavevector polar angles.</span>
<span class="sd">        k_amp_unique (np.ndarray): Unique wavevector magnitudes.</span>
<span class="sd">        k_amp_unique_index (np.ndarray): Indices for unique k_amp.</span>
<span class="sd">        theta_unique (np.ndarray): Unique polar angles.</span>
<span class="sd">        theta_unique_index (np.ndarray): Indices for unique theta.</span>
<span class="sd">        scalar_pk_k3 (np.ndarray): Primordial power spectrum divided by k^3.</span>
<span class="sd">        transfer_T_delta_kl (np.ndarray): T transfer functions for unique k.</span>
<span class="sd">        transfer_E_delta_kl (np.ndarray): E transfer functions for unique k.</span>
<span class="sd">        lm_index (np.ndarray): Indices for spherical harmonic coefficients.</span>
<span class="sd">        integrand (np.ndarray): Preprocessed integrand for covariance computation.</span>
<span class="sd">        C_lmlpmp (np.ndarray): Covariance matrix.</span>
<span class="sd">        normalized_C_lmlpmp (np.ndarray): Rescaled covariance matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_run_folder</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Topology class with simulation parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            param (dict): Parameters including topology, l_max, l_min, c_l_accuracy,</span>
<span class="sd">                          do_polarization, etc.</span>
<span class="sd">            debug (bool, optional): Enable debug output. Defaults to True.</span>
<span class="sd">            make_run_folder (bool, optional): Create output directories. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;topology&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;l_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;l_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;c_l_accuracy&#39;</span><span class="p">]</span>
        <span class="n">C_l_type_array</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span><span class="s1">&#39;EE&#39;</span><span class="p">,</span><span class="s1">&#39;TE&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_l_type_array</span> <span class="o">=</span> <span class="n">C_l_type_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;do_polarization&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig_name</span> <span class="o">=</span> <span class="s1">&#39;l_max_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_run_folder</span> <span class="o">=</span> <span class="n">make_run_folder</span>

        <span class="c1"># Create output directories</span>
        <span class="k">if</span> <span class="n">make_run_folder</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Making run folder:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">+</span><span class="s1">&#39;figs/&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">+</span><span class="s1">&#39;realizations/&#39;</span><span class="p">)</span> 

        <span class="c1"># Perform preprocessing</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_pre_processing</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to pre-process with l_max=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s1"> and accuracy=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="si">}</span><span class="s1">: &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Topology.do_pre_processing">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.do_pre_processing">[docs]</a>
    <span class="k">def</span> <span class="nf">do_pre_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform preprocessing for covariance matrix computation.</span>

<span class="sd">        Sets up CAMB parameters, computes transfer functions, primordial power spectrum,</span>
<span class="sd">        and spherical harmonics, optimizing for memory efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure CAMB parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">CAMBparams</span><span class="p">()</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_cosmology</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="mf">67.5</span><span class="p">,</span> <span class="n">ombh2</span><span class="o">=</span><span class="mf">0.022</span><span class="p">,</span> <span class="n">omch2</span><span class="o">=</span><span class="mf">0.122</span><span class="p">,</span> <span class="n">mnu</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">omk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">As</span><span class="o">=</span><span class="mf">2e-9</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="mf">0.965</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_for_lmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>

        <span class="c1"># More accurate transfer functions. Takes longer time to run</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_accuracy</span><span class="p">(</span><span class="n">AccuracyBoost</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lAccuracyBoost</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lSampleBoost</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">IntkAccuracyBoost</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">SourcekAccuracyBoost</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Compute transfer functions and power spectra</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_transfer_functions</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powers</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_cmb_power_spectra</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">raw_cl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">CMB_unit</span><span class="o">=</span><span class="s1">&#39;muK&#39;</span><span class="p">)[</span><span class="s1">&#39;unlensed_scalar&#39;</span><span class="p">]</span>
        <span class="n">transfer_function</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_cmb_transfer_data</span><span class="p">(</span><span class="n">tp</span><span class="o">=</span><span class="s1">&#39;scalar&#39;</span><span class="p">)</span>


        <span class="c1"># To get C_\ell in units of umK, we multiply by 1e6 (K to micro K) and the temperature of the CMB in K</span>
        <span class="n">transfer_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transfer_function</span><span class="o">.</span><span class="n">delta_p_l_k</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="mf">2.7255</span>  <span class="c1"># Convert to muK</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shape of transfer function from CAMB: </span><span class="si">{</span><span class="n">transfer_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># CAMB gives the transfer data for a set of k and ell. Store these values</span>
        <span class="c1"># and later we will use interpolation for other k/ell values.</span>
        <span class="c1">#k is in Mpc^{-1}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transfer_function</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ell_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transfer_function</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>

        <span class="c1"># Calculates the transfer functions, primordial power spectrum,</span>
        <span class="c1"># and spherical harmonics and stores them with as little memory as possible</span>

        <span class="n">l_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
        <span class="n">l_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span>

        <span class="c1"># Get the transfer functions and put them into lists of interpolate objects.</span>
        <span class="c1"># We can therefore evaluate the transfer function for all possibel |k| later</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ell_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ell_list</span><span class="p">[</span><span class="n">l_max</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">l_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_interpolate_k_l_list</span> <span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_interpolate_k_l_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="n">transfer_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="n">transfer_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span> 
            
        <span class="c1"># Compute wavevector cutoffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_kmax_as_function_of_ell</span><span class="p">(</span><span class="n">pars</span><span class="o">.</span><span class="n">scalar_power</span><span class="p">)</span>
        
        <span class="c1"># We find all allowed |k|, phi, theta and put them in big lists</span>
        <span class="c1"># The function get_list_of_k_phi_theta is specific to each topology</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_of_k_phi_theta</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to get list of k, phi, theta:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>

        <span class="c1"># |k|, phi and theta often repeats themselves. We do not want to recalculate spherical harmonics</span>
        <span class="c1"># twice or more so we store a list of all unique thetas. Same for |k| to quickly find transfer functions later</span>
        <span class="c1"># Optimize memory by storing unique k and theta</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_unique_index</span> <span class="o">=</span> <span class="n">get_k_theta_index_repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to get unique k and theta:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>


        <span class="c1"># Get P(k) / k^3 for all unique |k| values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalar_pk_k3</span> <span class="o">=</span> <span class="n">pars</span><span class="o">.</span><span class="n">scalar_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="o">**</span><span class="mi">3</span>

        <span class="c1"># Get the transfer function for all unique |k| values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transfer_functions_multi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_interpolate_k_l_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_delta_kl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transfer_functions_multi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_interpolate_k_l_list</span><span class="p">)</span>
        
        <span class="c1"># Store spherical harmonic indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lm_index</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_lm_idx</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="c1"># Compute spherical harmonics </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_sph_harm</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">**************</span><span class="se">\n</span><span class="s1">Done with all preprocessing</span><span class="se">\n</span><span class="s1">**************&#39;</span><span class="p">)</span></div>


        <span class="c1"># Get the spherical harmonics without the phase (without exp(i*m*phi))</span>
        <span class="c1"># We store these in an array of size (all lm, all n_z, all n*x^2+n_y^2)</span>
        <span class="c1"># This is because theta can be found from nz and nx^2+ny^2, and we do not</span>
        <span class="c1"># care about phi since we can add the phase in the sum</span>
        <span class="c1">#start_time = time.time()</span>

        

   
<div class="viewcode-block" id="Topology.calculate_c_lmlpmp">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.calculate_c_lmlpmp">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_c_lmlpmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_param</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the CMB covariance matrix C_lmlpmp.</span>

<span class="sd">        Args:</span>
<span class="sd">            normalize (bool, optional): Normalize the covariance matrix. Defaults to False.</span>
<span class="sd">            plot_param (dict, optional): Parameters for plotting (e.g., l_ranges, lp_ranges).</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Covariance matrix C_lmlpmp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating covariance matrix&#39;</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="n">integrand_TT</span> <span class="o">=</span> <span class="n">do_integrand_pre_processing</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_pk_k3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>
            <span class="n">integrand_EE</span> <span class="o">=</span> <span class="n">do_integrand_pre_processing</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_pk_k3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_delta_kl</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_delta_kl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>
            <span class="n">integrand_TE</span> <span class="o">=</span> <span class="n">do_integrand_pre_processing</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_pk_k3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_delta_kl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">integrand_TT</span><span class="p">,</span> <span class="n">integrand_EE</span><span class="p">,</span> <span class="n">integrand_TE</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrand</span> <span class="o">=</span> <span class="n">do_integrand_pre_processing</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_pk_k3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_delta_kl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>

       
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Size of integrand: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrand</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">integrand</span><span class="o">.</span><span class="n">itemsize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1"> MB&#39;</span><span class="p">)</span>

        <span class="n">l_min</span> <span class="o">=</span> <span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;l_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">l_max</span> <span class="o">=</span> <span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;l_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">lp_min</span> <span class="o">=</span> <span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;lp_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lp_max</span> <span class="o">=</span> <span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;lp_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Make sure the l_ranges do not overlap!</span>
        <span class="n">ell_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;l_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">ell_p_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_param</span><span class="p">[</span><span class="s1">&#39;lp_ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
 
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">C_lmlpmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_c_lmlpmp_multiprocessing</span><span class="p">(</span>
            <span class="n">ell_range</span> <span class="o">=</span> <span class="n">ell_range</span><span class="p">,</span>
            <span class="n">ell_p_range</span> <span class="o">=</span> <span class="n">ell_p_range</span><span class="p">,)</span>
        <span class="n">total_time_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">hours</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">total_time_seconds</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to get Correlation functions: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_lmlpmp</span> <span class="o">=</span> <span class="n">C_lmlpmp</span>

        <span class="c1"># Save covariance matrix</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;full&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;TT&quot;</span><span class="si">}</span><span class="s1">_corr_matrix_l_</span><span class="si">{</span><span class="n">l_min</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l_max</span><span class="si">}</span><span class="s1">_lp_</span><span class="si">{</span><span class="n">lp_min</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lp_max</span><span class="si">}</span><span class="s1">.npy&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">C_lmlpmp</span><span class="p">)</span>
            
        <span class="c1"># Normalize if requested</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">normalized_C_lmlpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C_lmlpmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cl_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]):</span>  <span class="c1"># TT, EE, TE</span>
                    <span class="n">normalized_C_lmlpmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize_c_lmlpmp</span><span class="p">(</span>
                        <span class="n">C_lmlpmp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[:,</span> <span class="n">cl_type</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[:,</span> <span class="n">cl_type</span><span class="p">],</span>
                        <span class="n">l_min</span><span class="o">=</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">=</span><span class="n">l_max</span><span class="p">,</span> <span class="n">lp_min</span><span class="o">=</span><span class="n">lp_min</span><span class="p">,</span> <span class="n">lp_max</span><span class="o">=</span><span class="n">lp_max</span><span class="p">,</span>
                        <span class="n">cl_accuracy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normalized_C_lmlpmp</span> <span class="o">=</span> <span class="n">normalize_c_lmlpmp</span><span class="p">(</span>
                    <span class="n">C_lmlpmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">l_min</span><span class="o">=</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">=</span><span class="n">l_max</span><span class="p">,</span> <span class="n">lp_min</span><span class="o">=</span><span class="n">lp_min</span><span class="p">,</span> <span class="n">lp_max</span><span class="o">=</span><span class="n">lp_max</span><span class="p">,</span>
                    <span class="n">cl_accuracy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;norm_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">normalized_C_lmlpmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_C_lmlpmp</span> <span class="o">=</span> <span class="n">normalized_C_lmlpmp</span>
        
        <span class="k">return</span> <span class="n">C_lmlpmp</span></div>

    
<div class="viewcode-block" id="Topology.plot_cov_matrix">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.plot_cov_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cov_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">C_l_type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the covariance matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            normalize (bool, optional): Plot normalized matrix. Defaults to False.</span>
<span class="sd">            C_l_type (int, optional): Correlation type (0: TT, 1: EE, 2: TE, 3: All). Defaults to 3.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
        <span class="n">ell_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="n">l_max</span><span class="p">])</span>
        <span class="n">ell_p_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="n">l_max</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">C_l_type</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_C_lmlpmp</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_lmlpmp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_cov_sub_plot</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$TE$&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_cov_sub_plot</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$TT$&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_cov_sub_plot</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$EE$&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_cov_sub_plot</span><span class="p">(</span><span class="n">ax4</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$ET$&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_C_lmlpmp</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_lmlpmp</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">C_l_type</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span> <span class="k">else</span> <span class="n">data</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;$TT$&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;$EE$&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;$TE$&#39;</span><span class="p">}[</span><span class="n">C_l_type</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_cov_sub_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span></div>




        
    
<div class="viewcode-block" id="Topology.do_cov_sub_plot">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.do_cov_sub_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">do_cov_sub_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">,</span> <span class="n">C_order</span><span class="p">,</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a subplot for the covariance matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax (matplotlib.axes.Axes): Subplot axes.</span>
<span class="sd">            normalize (bool): Use normalized data.</span>
<span class="sd">            ax_index (int): Subplot index.</span>
<span class="sd">            C_order (np.ndarray): Covariance matrix data.</span>
<span class="sd">            ell_range (np.ndarray): Multipole range [l_min, l_max].</span>
<span class="sd">            ell_p_range (np.ndarray): Multipole range [lp_min, lp_max].</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib.image.AxesImage: Image object for colorbar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">l_min</span> <span class="o">=</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l_max</span> <span class="o">=</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lp_min</span> <span class="o">=</span> <span class="n">ell_p_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lp_max</span> <span class="o">=</span> <span class="n">ell_p_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">C_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">C_order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">C_order</span><span class="p">))</span>

        <span class="n">ell_to_s_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="n">l_min</span><span class="o">**</span><span class="mi">2</span>  <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">ellp_to_s_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="n">lp_min</span><span class="o">**</span><span class="mi">2</span>  <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lp_min</span><span class="p">,</span> <span class="n">lp_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>

        <span class="n">axim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">C_order</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">l_max</span><span class="o">-</span><span class="n">l_min</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">jump</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ell_to_s_map</span><span class="p">[</span><span class="n">jump</span><span class="p">]</span><span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">jump</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ell_to_s_map</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">lp_max</span><span class="o">-</span><span class="n">lp_min</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">jump</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ellp_to_s_map</span><span class="p">[</span><span class="n">jump</span><span class="p">]</span><span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lp_min</span><span class="p">,</span> <span class="n">lp_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">jump</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ellp_to_s_map</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lp_min</span><span class="p">,</span> <span class="n">lp_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">lp_max</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="n">l_max</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ax_index</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;20&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ax_index</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;20&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ax_index</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">ax_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\ell $&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ax_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\ell $&quot;</span><span class="p">)</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\ell&#39;$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">axim</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axim</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">axim</span></div>


     
<div class="viewcode-block" id="Topology.get_kmax_as_function_of_ell">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.get_kmax_as_function_of_ell">[docs]</a>
    <span class="k">def</span> <span class="nf">get_kmax_as_function_of_ell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar_power</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute wavevector cutoffs k_max as a function of multipole ell.</span>

<span class="sd">        Args:</span>
<span class="sd">            scalar_power (callable): Primordial power spectrum function from CAMB.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
    
        <span class="c1"># Do the integration up to k=0.08. This should be fine for ell=&lt;250 and accuracy&lt;=0.99</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Finding k_max as a function of ell&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">k_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">200000</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">integrand_TT</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">scalar_power</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">k_list</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_list</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
                <span class="n">integrand_EE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scalar_power</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span> <span class="o">*</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">k_list</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_list</span><span class="p">)</span>
                <span class="n">integrand_TE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">scalar_power</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span> <span class="o">*</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_T_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">k_list</span><span class="p">)</span> <span class="o">*</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_E_interpolate_k_l_list</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">k_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">k_list</span><span class="p">)</span>
                <span class="n">cumulative_c_l_TT_ratio</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">integrand_TT</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">k_list</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">cumulative_c_l_EE_ratio</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">integrand_EE</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">k_list</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">cumulative_c_l_TE_ratio</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">integrand_TE</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">k_list</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">k_list</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumulative_c_l_TT_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()],</span>
                    <span class="n">k_list</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumulative_c_l_EE_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()],</span>
                    <span class="n">k_list</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumulative_c_l_TE_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cumulative_c_l_TT_ratio</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">integrand_TT</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">k_list</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_list</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cumulative_c_l_TT_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_l_accuracy</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_run_folder</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;k_max_list.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done. k_max for ell_max = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    
    
<div class="viewcode-block" id="Topology.get_transfer_functions_multi">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.get_transfer_functions_multi">[docs]</a>
    <span class="k">def</span> <span class="nf">get_transfer_functions_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_interpolate_k_l_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute transfer functions for unique wavevector magnitudes using multiprocessing.</span>

<span class="sd">        Args:</span>
<span class="sd">            transfer_interpolate_k_l_list (dict): Interpolated transfer functions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Transfer functions for unique k.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">num_k_amp_unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="o">.</span><span class="n">size</span>
        <span class="n">transfer_delta_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_k_amp_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">ncpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">ncpus</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Getting transfer functions&#39;</span><span class="p">)</span>
        
        <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_k_amp_unique</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">transfer_interpolate_k_l_list</span><span class="p">))</span>
        
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">ncpus</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">transfer_delta_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">transfer_parallel</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">num_k_amp_unique</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of transfer function: </span><span class="si">{}</span><span class="s1"> MB.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">transfer_delta_kl</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 

        <span class="k">return</span> <span class="n">transfer_delta_kl</span> </div>

    
    
    
<div class="viewcode-block" id="Topology.get_sph_harm">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.get_sph_harm">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sph_harm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute spherical harmonics without phase(phi=0) using multiprocessing.</span>

<span class="sd">        Stores results in self.sph_harm_no_phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_l_m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># We only find Y_lm for unique theta elements. We don&#39;t want to recalculate Y_lm unnecessarily</span>
        <span class="n">unique_theta_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_unique</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ncpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">ncpus</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Getting spherical harmonics&#39;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">unique_theta_length</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_unique</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lm_index</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">num_l_m</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">ncpus</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sph_harm_no_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">get_sph_harm_parallel</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">unique_theta_length</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The spherical harmonics array is&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">getsizeof</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sph_harm_no_phase</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MB </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="Topology.get_c_lmlpmp_multiprocessing">
<a class="viewcode-back" href="../../../api.html#topology.src.topology.Topology.get_c_lmlpmp_multiprocessing">[docs]</a>
    <span class="k">def</span> <span class="nf">get_c_lmlpmp_multiprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_range</span><span class="p">,</span> <span class="n">ell_p_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute covariance matrix using multiprocessing.</span>

<span class="sd">        Args:</span>
<span class="sd">            ell_range (np.ndarray): Multipole range [l_min, l_max].</span>
<span class="sd">            ell_p_range (np.ndarray): Multipole range [lp_min, lp_max].</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Covariance matrix C_lmlpmp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
        <span class="n">l_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span>
        <span class="n">num_l_m</span> <span class="o">=</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ell_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># = Sum[2 l+1, {l , l_min, l_max}]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="n">c_lmlpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_l_m</span><span class="p">,</span> <span class="n">num_l_m</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_lmlpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_l_m</span><span class="p">,</span> <span class="n">num_l_m</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        
        <span class="n">ncpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">semi_jumps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ncpus</span><span class="p">))</span>
        <span class="n">index_thread_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l_min</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index_thread_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index_thread_split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ell</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index_thread_split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">&gt;=</span> <span class="n">semi_jumps</span><span class="p">:</span>
                <span class="n">index_thread_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_thread_split</span><span class="p">,</span> <span class="n">ell</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">index_thread_split</span><span class="o">.</span><span class="n">size</span>
        <span class="n">index_thread_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_thread_split</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


        <span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Spawn a process for each cpu that goes through parts of the summation each</span>
            <span class="n">min_ell</span> <span class="o">=</span> <span class="n">index_thread_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># minimum index in the k_amp list not unique </span>
            <span class="n">max_ell</span> <span class="o">=</span> <span class="n">index_thread_split</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">return_dict</span><span class="p">,</span>
                <span class="n">min_ell</span><span class="p">,</span>
                <span class="n">max_ell</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">theta_unique_index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_amp_unique_index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_max_list</span><span class="p">,</span>
                <span class="n">l_max</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lm_index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sph_harm_no_phase</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrand</span><span class="p">,</span>
                <span class="n">ell_range</span><span class="p">,</span>
                <span class="n">ell_p_range</span>
            <span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_c_lmlpmp_per_process_multi</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1">#Waits for each process to complete before moving on.</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            

        <span class="c1"># The final c_lmlpmp that is the sum of contribution from each process  </span>
        <span class="n">c_lmlpmp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">return_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># We only compute the upper triangle of the covariance matrix, so we need to</span>
        <span class="c1"># conjugate the lower triangle to get the full covariance matrix.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_polarization</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ell_p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ell</span><span class="p">,</span> <span class="n">ell</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">m_p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ell_p</span><span class="p">,</span> <span class="n">ell_p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">lm_p_index</span> <span class="o">=</span> <span class="n">ell_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m_p</span> <span class="o">-</span> <span class="n">l_min</span> <span class="o">*</span> <span class="n">l_min</span>
                            <span class="n">lm_index</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l_min</span> <span class="o">*</span> <span class="n">l_min</span>
                            <span class="n">c_lmlpmp</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="n">lm_p_index</span><span class="p">,</span> <span class="n">lm_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">c_lmlpmp</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="n">lm_index</span><span class="p">,</span> <span class="n">lm_p_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ell_p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ell</span><span class="p">,</span> <span class="n">ell</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">m_p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ell_p</span><span class="p">,</span> <span class="n">ell_p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">lm_p_index</span> <span class="o">=</span> <span class="n">ell_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell_p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m_p</span> <span class="o">-</span> <span class="n">l_min</span> <span class="o">*</span> <span class="n">l_min</span>
                            <span class="n">lm_index</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l_min</span> <span class="o">*</span> <span class="n">l_min</span>
                            <span class="n">c_lmlpmp</span><span class="p">[</span><span class="n">lm_p_index</span><span class="p">,</span> <span class="n">lm_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">c_lmlpmp</span><span class="p">[</span><span class="n">lm_index</span><span class="p">,</span> <span class="n">lm_p_index</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">c_lmlpmp</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Amirhossein Samandar.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>